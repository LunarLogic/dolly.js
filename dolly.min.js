(function(d){d.widget("llp.dolly",{options:{rowSelector:"tr",cellSelector:"td",boxStyle:{border:"2px dotted black"},handleStyle:{width:"8px",height:"8px","background-color":"black",cursor:"crosshair"}},_boxStyle:{position:"absolute",width:"100%",height:"100%","z-index":"1000"},_handleStyle:{position:"absolute"},_wrapperStyle:{position:"relative",height:"100%",width:"100%",display:"inline-block"},_create:function(){var a=this;this._box=d('<div class="dolly-box" style="visibility: hidden"></div>');
this._handle=d('<div class="dolly-handle" style="visibility: hidden"></div>');this._wrapper=d('<div id="dolly-wrapper"></div>');this._wrapper.css(this._wrapperStyle);this._handle.css({right:-1*this._getCssAsNumber("padding-right")+"px",bottom:-1*this._getCssAsNumber("padding-bottom")+"px"});this._handle.css(this.options.handleStyle);this._handle.css(this._handleStyle);this._box.css(this.options.boxStyle);this._box.css(this._boxStyle);this._boxBorder=this._getCssAsNumber("border-width",this._box);
this.element.wrapInner(this._wrapper);this._wrapper=this.element.find("div#dolly-wrapper");this._wrapper.append(this._box);this._wrapper.append(this._handle);this.element.hover(function(){a._handle.css({visibility:"visible"})},function(){a._handle.css({visibility:"hidden"})});this._handle.on("mousedown",function(b){a._initialX=b.pageX;a._initialY=b.pageY;a._cloneX=0;a._cloneY=0;a._box.css({visibility:"visible"});d("body").find(".dolly-handle").css({display:"none"});a._resetBoxSize();a._setTopLeftBoxPosition();
d(window).disableSelection();var c=function(b){a._handleDrag(b)},e=function(){a._box.css({visibility:"hidden"});d("body").find(".dolly-handle").css({display:""});d(window).enableSelection();d(window).off("mousemove",c);d(window).off("mouseup",e);a._trigger("cloned",null,{cloneX:a._cloneX,cloneY:a._cloneY,originX:a._getOriginX(),originY:a._getOriginY()})};d(window).on("mousemove",c);d(window).on("mouseup",e)})},_handleDrag:function(a){this._resetBoxSize();var b=this._cloneX,c=this._cloneY;this._cloneY=
this._cloneX=0;Math.abs(a.pageX-this._initialX)>Math.abs(a.pageY-this._initialY)?this._getCellsHorizontally(a.pageX):this._getCellsVertically(a.pageY);b===this._cloneX&&c===this._cloneY||this._trigger("selected",null,{cloneX:this._cloneX,cloneY:this._cloneY,originX:this._getOriginX(),originY:this._getOriginY()})},_getCellsHorizontally:function(a){a<this._initialX?(this._setBottomRightBoxPosition(),this._getCellsLeft(this.element,a)):(this._setTopLeftBoxPosition(),this._getCellsRight(this.element,
a))},_getCellsVertically:function(a){a<this._initialY?(this._setBottomRightBoxPosition(),this._getCellsUp(this.element,a)):(this._setTopLeftBoxPosition(),this._getCellsDown(this.element,a))},_getCellsUp:function(a,b){var c=a.closest(this.options.rowSelector).find(this.options.cellSelector).index(this.element),c=d(a.closest(this.options.rowSelector).prev(this.options.rowSelector).find(this.options.cellSelector).get(c));0===c.length||b>this._getCellEdges(c).bottom-10||(this._cloneY-=1,this._box.height(this._box.offset().top+
this._box.height()-this._getCellEdges(c).top+this._boxBorder),this._getCellsUp(c,b))},_getCellsLeft:function(a,b){var c=a.prev(this.options.cellSelector);0===c.length||b>this._getCellEdges(c).right-10||(this._cloneX-=1,this._box.width(this._box.offset().left+this._box.width()-this._getCellEdges(c).left+this._boxBorder),this._getCellsLeft(c,b))},_getCellsRight:function(a,b){var c=a.next(this.options.cellSelector);0===c.length||b<c.offset().left+10||(this._cloneX+=1,this._box.width(this._getCellEdges(c).right-
this._box.offset().left-this._boxBorder),this._getCellsRight(c,b))},_getCellsDown:function(a,b){var c=a.closest(this.options.rowSelector).find(this.options.cellSelector).index(this.element),c=d(a.closest(this.options.rowSelector).next(this.options.rowSelector).find(this.options.cellSelector).get(c));0===c.length||b<c.offset().top+10||(this._cloneY+=1,this._box.height(this._getCellEdges(c).bottom-this._box.offset().top-this._boxBorder),this._getCellsDown(c,b))},_resetBoxSize:function(){this._box.width(this._getCellSize().width);
this._box.height(this._getCellSize().height)},_setTopLeftBoxPosition:function(){this._box.css({top:-1*this._getCssAsNumber("padding-top")-this._boxBorder+"px",left:-1*this._getCssAsNumber("padding-left")-this._boxBorder+"px",bottom:"",right:""})},_setBottomRightBoxPosition:function(){this._box.css({bottom:-1*this._getCssAsNumber("padding-bottom")-this._boxBorder+"px",right:-1*this._getCssAsNumber("padding-right")-this._boxBorder+"px",top:"",left:""})},_getCellEdges:function(a){var b=a.find("#dolly-wrapper");
return{top:b.offset().top-this._getCssAsNumber("padding-top",a),bottom:b.offset().top+b.height()+this._getCssAsNumber("padding-bottom",a),left:b.offset().left-this._getCssAsNumber("padding-left",a),right:b.offset().left+b.width()+this._getCssAsNumber("padding-right",a)}},_getCellSize:function(a){a=a||this.element;var b=a.find("#dolly-wrapper");return{width:this._getCssAsNumber("padding-left",a)+this._getCssAsNumber("padding-right",a)+b.width(),height:this._getCssAsNumber("padding-top",a)+this._getCssAsNumber("padding-bottom",
a)+b.height()}},_getCssAsNumber:function(a,b){b=b||this.element;return parseInt(b.css(a),10)},_getOriginX:function(){return this.element.closest(this.options.rowSelector).find(this.options.cellSelector).index(this.element)},_getOriginY:function(){var a=this.element.closest(this.options.rowSelector);return a.parent().find(this.options.rowSelector).index(a)}})})(jQuery);
